"""Translation utilities for the Takken app."""
from __future__ import annotations

from typing import Dict, Iterable, Optional

import streamlit as st

DEFAULT_LANGUAGE = "ja"

LANGUAGE_CHOICES: Iterable[str] = ("ja", "en")

TRANSLATIONS: Dict[str, Dict[str, str]] = {
    "ja": {
        "app.title": "宅建10年ドリル",
        "nav.menu": "メニュー",
        "nav.learning": "学習",
        "nav.mock_exam": "模試",
        "nav.stats": "統計",
        "nav.settings": "設定",
        "nav.guide.title": "モード別の使い方ガイド",
        "nav.guide.learning": "- **学習**：演習プラン・特別対策・弱点ケアのタブから目的に応じて学習モードを選択します。",
        "nav.guide.mock": "- **模試**：年度や出題方式を指定して本番同様の模試を開始します。",
        "nav.guide.stats": "- **統計**：分野別の成績や時間分析を把握できます。",
        "nav.guide.settings": "- **設定**：表示設定の調整と『設定 ＞ データ入出力』タブでのCSV/ZIP取り込みをまとめています。",
        "language.label": "表示言語",
        "language.ja": "日本語",
        "language.en": "English",
        "settings.title": "設定",
        "settings.tab.display": "表示・操作設定",
        "settings.tab.data": "データ入出力",
        "settings.intro": "学習体験を自分好みにカスタマイズできます。各項目の説明を参考に調整してください。",
        "settings.theme.label": "テーマ",
        "settings.theme.help": "画面の配色を切り替えます。暗い環境ではダークテーマ、長文読解にはセピアテーマがおすすめです。",
        "settings.theme.option.light": "ライト",
        "settings.theme.option.dark": "ダーク",
        "settings.theme.option.sepia": "セピア",
        "settings.font_size.label": "フォントサイズ",
        "settings.font_size.help": "文字サイズを調整して読みやすさを最適化します。『大きい』は夜間学習や高解像度モニタ向きです。",
        "settings.font_size.option.small": "やや小さい",
        "settings.font_size.option.standard": "標準",
        "settings.font_size.option.medium": "やや大きい",
        "settings.font_size.option.large": "大きい",
        "settings.shuffle_choices": "選択肢をシャッフル",
        "settings.shuffle_choices.help": "毎回選択肢の順番をランダムに入れ替えて、位置記憶に頼らない訓練を行います。",
        "settings.timer": "タイマーを表示",
        "settings.timer.help": "回答画面に経過時間を表示して本番同様の時間感覚を養います。",
        "settings.sm2.label": "SM-2初期ease",
        "settings.sm2.help": "間隔反復アルゴリズムの初期難易度です。既定値2.5で迷ったらそのままにしましょう。",
        "settings.auto_advance": "採点後に自動で次問へ進む (0.8秒遅延)",
        "settings.auto_advance.help": "誤判定後に待機せず次の問題へ進みたい場合に有効化します。",
        "settings.review.low_confidence": "低確信として扱う確信度 (%)",
        "settings.review.low_confidence.help": "自己評価の確信度がこの値未満なら復習対象に含めます。",
        "settings.review.elapsed_days": "復習抽出の経過日数しきい値",
        "settings.review.elapsed_days.help": "最終挑戦からこの日数が経過した問題を復習候補に追加します。",
        "settings.integrations.heading": "外部サービス連携設定",
        "settings.integrations.caption": "Google Calendar や Notion 連携に必要なOAuth情報を入力してください。値はブラウザセッション内で保持されます。",
        "settings.google.expander": "Google Calendar 連携",
        "settings.google.client_id": "Client ID",
        "settings.google.client_secret": "Client Secret",
        "settings.google.redirect_uri": "Redirect URI",
        "settings.google.redirect_uri.help": "OAuth同意画面で設定したリダイレクトURLを入力してください。",
        "settings.google.access_token": "Access Token",
        "settings.google.access_token.help": "有効なアクセストークンを入力すると即時同期できます。",
        "settings.google.refresh_token": "Refresh Token",
        "settings.google.calendar_id": "対象カレンダーID",
        "settings.google.calendar_id.help": "primary のままにするとメインカレンダーへ書き込みます。",
        "settings.notion.expander": "Notion 連携",
        "settings.notion.token": "Integration Token",
        "settings.notion.database_id": "データベースID",
        "settings.notion.version": "Notion-Version",
        "settings.notion.version.help": "Notion APIのバージョン文字列を必要に応じて変更してください。",
        "settings.tfidf": "TF-IDFを再学習",
        "settings.tfidf.help": "検索精度が気になるときに再計算します。データ更新後の再実行がおすすめです。",
        "settings.tfidf.success": "TF-IDFを再学習しました",
        "quick_import.caption": "questions.csv と answers.csv をまとめてドラッグ＆ドロップできます。必要な方だけでも取り込めます。",
        "quick_import.uploader": "questions.csv / answers.csv をアップロード",
        "quick_import.help": "複数ファイルを同時に選択すると自動で候補に入ります。",
        "quick_import.drop_caption": "ドロップゾーンに追加したファイルが候補として表示されています。",
        "quick_import.no_files": "ファイルを選択するとここに一覧表示されます。上部のドロップゾーンか右のボタンから追加してください。",
        "quick_import.option.none": "選択しない",
        "quick_import.select.questions": "questions.csv",
        "quick_import.select.answers": "answers.csv",
        "quick_import.button": "クイックインポート実行",
        "quick_import.prompt.select_file": "questions.csv か answers.csv のいずれかを選択してください。",
        "quick_import.template_hint": "テンプレートの列構成と突合してください。『テンプレートをダウンロード』から最新のCSVサンプルを取得できます。",
        "quick_import.error.normalize_questions": "questions.csv の整形に失敗しました: {error}",
        "quick_import.error.normalize_answers": "answers.csv の整形に失敗しました: {error}",
        "quick_import.warning.normalize_failed": "列名や値の形式を見直してから再度インポートしてください。",
        "quick_import.error.answers_without_questions": "設問データが存在しません。answers.csv を取り込む前に questions.csv を読み込んでください。",
        "quick_import.status.success": "クイックインポートが完了しました。追加 {inserted} 件 / 更新 {updated} 件",
        "quick_import.status.warnings": "取り込めなかったレコードがあります。questions: {questions} 件 / answers: {answers} 件",
        "quick_import.rejects.questions": "**questions.csv**",
        "quick_import.rejects.answers": "**answers.csv**",
        "quick_import.rejects.caption": "理由列を参考にCSVの該当行を修正してください。全件はrejects_*.csvでダウンロードできます。",
        "quick_import.rejects.expander": "取り込めなかった行の詳細",
        "quick_import.conflicts": "正答の衝突が {count} 件あり、上書きしました。",
        "quick_import.heading.home": "#### クイックインポート (questions.csv / answers.csv)",
        "quick_import.heading.settings": "### クイックインポート (questions.csv / answers.csv)",
        "csv_import.guide.title": "**CSV取り込みの流れ**",
        "csv_import.guide.step1": "テンプレートZIPから questions.csv / answers.csv をダウンロードする",
        "csv_import.guide.step2": "年度・問番・問題文などの必須列を埋め、Excel などで保存する",
        "csv_import.guide.step3": "『設定 ＞ データ入出力』でファイルをアップロードする",
        "csv_import.guide.step4": "バリデーション結果でエラー行を確認し、必要に応じて再修正する",
        "csv_import.guide.step5": "正常に取り込めたらTF-IDFの再学習や履歴エクスポートを活用する",
        "csv_import.guide.video": "動画で手順を確認する",
        "history_export.attempts.download": "attempts.csv をダウンロード",
        "history_export.attempts.empty": "attempts.csv：学習履歴はまだありません。学習モードで解答するとダウンロード可能になります。",
        "history_export.exams.download": "exams.csv をダウンロード",
        "history_export.exams.empty": "exams.csv：模試の受験履歴はまだありません。模試モードで本試験を体験しましょう。",
        "history_export.sqlite.download": "SQLiteバックアップをダウンロード",
        "data_io.header": "データ入出力",
        "data_io.password.warning": "データ入出力の管理パスワードが設定されていません。Streamlit の secrets もしくは DATA_IO_PASSWORD 環境変数に値を設定してください。",
        "data_io.password.label": "データ入出力パスワード",
        "data_io.password.submit": "認証",
        "data_io.password.prompt": "データ入出力パスワードを入力してください。",
        "data_io.password.invalid": "パスワードが正しくありません。",
        "data_io.history": "インポート履歴 (このセッション)",
        "data_io.history.timestamp": "完了時刻",
        "data_io.history.inserted": "追加",
        "data_io.history.updated": "更新",
        "data_io.history.rejected": "リジェクト",
        "data_io.history.seconds": "処理秒数",
        "data_io.templates": "テンプレートファイル",
        "data_io.templates.download": "テンプレートをダウンロード (ZIP)",
        "data_io.templates.caption": "設問・正答データのCSV/XLSXテンプレートが含まれます。必要に応じて編集してご利用ください。",
        "data_io.schema.guide": "📘 データ列の詳細仕様は下記のスキーマガイドで確認できます。テンプレート編集前にご覧ください。",
        "data_io.schema.expander": "questions.csv / answers.csv / law_revision.csv のスキーマガイド",
        "data_io.sample.questions": "サンプル questions.csv",
        "data_io.sample.answers": "サンプル answers.csv",
        "data_io.sample.predicted": "サンプル predicted.csv",
        "data_io.sample.law_revision": "サンプル law_revision.csv",
        "data_io.sample.questions.help": "Excelで開いて値を上書きすれば、そのまま取り込みできます。",
        "data_io.sample.answers.help": "正答番号や解説の記入例です。コピーしてご利用ください。",
        "data_io.sample.predicted.help": "予想問題の入力例です。ラベルや出典を記入して活用ください。",
        "data_io.sample.law_revision.help": "最新の法改正論点を整理した問題サンプルです。改正年度や施行日を追記してご利用ください。",
    },
    "en": {
        "app.title": "Takken 10-Year Drill",
        "nav.menu": "Navigation",
        "nav.learning": "Learning",
        "nav.mock_exam": "Mock Exam",
        "nav.stats": "Analytics",
        "nav.settings": "Settings",
        "nav.guide.title": "How to use each mode",
        "nav.guide.learning": "- **Learning**: Choose a study mode (plans, special focus, or weak-point review) depending on your goal.",
        "nav.guide.mock": "- **Mock Exam**: Select an exam year and format to simulate the real test.",
        "nav.guide.stats": "- **Analytics**: Review performance by category and analyze timing data.",
        "nav.guide.settings": "- **Settings**: Adjust the interface and manage CSV/ZIP import from the “Settings > Data I/O” tab.",
        "language.label": "Language",
        "language.ja": "日本語",
        "language.en": "English",
        "settings.title": "Settings",
        "settings.tab.display": "Display & Controls",
        "settings.tab.data": "Data Import/Export",
        "settings.intro": "Tune the learning experience to your preference. Use the descriptions below as guidance for each option.",
        "settings.theme.label": "Theme",
        "settings.theme.help": "Switch the color palette. Dark works well at night, while Sepia is great for long reading sessions.",
        "settings.theme.option.light": "Light",
        "settings.theme.option.dark": "Dark",
        "settings.theme.option.sepia": "Sepia",
        "settings.font_size.label": "Font size",
        "settings.font_size.help": "Adjust the base font size for readability. “Large” is ideal for night study or high-DPI monitors.",
        "settings.font_size.option.small": "Slightly smaller",
        "settings.font_size.option.standard": "Standard",
        "settings.font_size.option.medium": "Slightly larger",
        "settings.font_size.option.large": "Large",
        "settings.shuffle_choices": "Shuffle choices",
        "settings.shuffle_choices.help": "Randomize answer choices on every attempt to reduce position-based memorization.",
        "settings.timer": "Show timer",
        "settings.timer.help": "Display the elapsed time during questions to build a real-exam pace.",
        "settings.sm2.label": "SM-2 initial ease",
        "settings.sm2.help": "Starting difficulty for the spaced-repetition algorithm. The default 2.5 works well in most cases.",
        "settings.auto_advance": "Auto-advance after grading (0.8s delay)",
        "settings.auto_advance.help": "Skip the waiting period after grading and jump straight to the next question.",
        "settings.review.low_confidence": "Confidence threshold for review (%)",
        "settings.review.low_confidence.help": "Attempts with self-rated confidence below this value will be flagged for review.",
        "settings.review.elapsed_days": "Days since last attempt for review",
        "settings.review.elapsed_days.help": "Include questions that haven’t been attempted for at least this number of days.",
        "settings.integrations.heading": "External integrations",
        "settings.integrations.caption": "Provide OAuth credentials for Google Calendar or Notion. Values are stored only in this browser session.",
        "settings.google.expander": "Google Calendar integration",
        "settings.google.client_id": "Client ID",
        "settings.google.client_secret": "Client Secret",
        "settings.google.redirect_uri": "Redirect URI",
        "settings.google.redirect_uri.help": "Enter the redirect URL configured for your OAuth consent screen.",
        "settings.google.access_token": "Access Token",
        "settings.google.access_token.help": "Provide a valid access token to sync immediately.",
        "settings.google.refresh_token": "Refresh Token",
        "settings.google.calendar_id": "Calendar ID",
        "settings.google.calendar_id.help": "Keep “primary” to use your default calendar.",
        "settings.notion.expander": "Notion integration",
        "settings.notion.token": "Integration Token",
        "settings.notion.database_id": "Database ID",
        "settings.notion.version": "Notion-Version",
        "settings.notion.version.help": "Change the Notion API version string if needed.",
        "settings.tfidf": "Retrain TF-IDF",
        "settings.tfidf.help": "Recompute search vectors when accuracy feels off. Recommended after updating data.",
        "settings.tfidf.success": "TF-IDF retraining completed",
        "quick_import.caption": "Drag and drop questions.csv and answers.csv together, or import either file on its own.",
        "quick_import.uploader": "Upload questions.csv / answers.csv",
        "quick_import.help": "Selecting multiple files adds them to the candidate list automatically.",
        "quick_import.drop_caption": "Files added via the drop zone appear as candidates below.",
        "quick_import.no_files": "Files will appear here after you select them. Use the drop zone above or the buttons on the right to add more.",
        "quick_import.option.none": "Do not import",
        "quick_import.select.questions": "questions.csv",
        "quick_import.select.answers": "answers.csv",
        "quick_import.button": "Run quick import",
        "quick_import.prompt.select_file": "Select either questions.csv or answers.csv to continue.",
        "quick_import.template_hint": "Verify the column layout against the templates. Download the latest CSV samples from “Download templates.”",
        "quick_import.error.normalize_questions": "Failed to normalize questions.csv: {error}",
        "quick_import.error.normalize_answers": "Failed to normalize answers.csv: {error}",
        "quick_import.warning.normalize_failed": "Review the column names and value formats, then try importing again.",
        "quick_import.error.answers_without_questions": "No question data found. Import questions.csv before processing answers.csv.",
        "quick_import.status.success": "Quick import completed. Added {inserted} / Updated {updated}",
        "quick_import.status.warnings": "Some rows could not be imported. questions: {questions} / answers: {answers}",
        "quick_import.rejects.questions": "**questions.csv**",
        "quick_import.rejects.answers": "**answers.csv**",
        "quick_import.rejects.caption": "Use the reason column to fix the affected CSV rows. You can download the full rejects_*.csv files.",
        "quick_import.rejects.expander": "Details for skipped rows",
        "quick_import.conflicts": "Detected and overwrote {count} conflicts in correct answers.",
        "quick_import.heading.home": "#### Quick import (questions.csv / answers.csv)",
        "quick_import.heading.settings": "### Quick import (questions.csv / answers.csv)",
        "csv_import.guide.title": "**CSV import flow**",
        "csv_import.guide.step1": "Download questions.csv / answers.csv from the template ZIP.",
        "csv_import.guide.step2": "Fill in the required columns such as year, question number, and prompt, then save from Excel or another editor.",
        "csv_import.guide.step3": "Upload the files via “Settings > Data Import/Export.”",
        "csv_import.guide.step4": "Check the validation results for error rows and fix them as needed.",
        "csv_import.guide.step5": "After importing successfully, retrain TF-IDF or export histories as needed.",
        "csv_import.guide.video": "Watch the walkthrough video",
        "history_export.attempts.download": "Download attempts.csv",
        "history_export.attempts.empty": "attempts.csv: no learning history yet. Start answering questions to enable downloads.",
        "history_export.exams.download": "Download exams.csv",
        "history_export.exams.empty": "exams.csv: no mock exam attempts yet. Try the mock exam mode to generate results.",
        "history_export.sqlite.download": "Download SQLite backup",
        "data_io.header": "Data Import/Export",
        "data_io.password.warning": "The data import/export password is not configured. Set it via Streamlit secrets or the DATA_IO_PASSWORD environment variable.",
        "data_io.password.label": "Import/Export password",
        "data_io.password.submit": "Authenticate",
        "data_io.password.prompt": "Enter the data import/export password.",
        "data_io.password.invalid": "Incorrect password.",
        "data_io.history": "Import history (this session)",
        "data_io.history.timestamp": "Completed at",
        "data_io.history.inserted": "Inserted",
        "data_io.history.updated": "Updated",
        "data_io.history.rejected": "Rejected",
        "data_io.history.seconds": "Seconds",
        "data_io.templates": "Template files",
        "data_io.templates.download": "Download templates (ZIP)",
        "data_io.templates.caption": "Includes CSV/XLSX templates for questions and answers. Edit as needed before importing.",
        "data_io.schema.guide": "📘 Review the schema guide below for column details before editing your templates.",
        "data_io.schema.expander": "Schema guide for questions.csv / answers.csv / law_revision.csv",
        "data_io.sample.questions": "Sample questions.csv",
        "data_io.sample.answers": "Sample answers.csv",
        "data_io.sample.predicted": "Sample predicted.csv",
        "data_io.sample.law_revision": "Sample law_revision.csv",
        "data_io.sample.questions.help": "Open in Excel, overwrite values, and import directly.",
        "data_io.sample.answers.help": "Example of answer numbers and explanations. Copy as needed.",
        "data_io.sample.predicted.help": "Example predicted questions with labels and sources.",
        "data_io.sample.law_revision.help": "Sample questions covering recent legal revisions. Add revision years or effective dates.",
    },
}


def get_current_language() -> str:
    """Return the current language stored in the Streamlit session state."""

    lang = st.session_state.get("language", DEFAULT_LANGUAGE)
    if lang not in TRANSLATIONS:
        return DEFAULT_LANGUAGE
    return lang


def set_current_language(lang: str) -> None:
    """Persist the selected language in the session state."""

    if lang in TRANSLATIONS:
        st.session_state["language"] = lang


def available_languages() -> Iterable[str]:
    return LANGUAGE_CHOICES


def translate(key: str, *, lang: Optional[str] = None, **kwargs) -> str:
    """Translate the given key into the current language, with fallback."""

    active_lang = lang or get_current_language()
    catalog = TRANSLATIONS.get(active_lang, {})
    default_catalog = TRANSLATIONS.get(DEFAULT_LANGUAGE, {})
    text = catalog.get(key) or default_catalog.get(key) or key
    if kwargs:
        try:
            text = text.format(**kwargs)
        except Exception:
            pass
    return text


def t(key: str, **kwargs) -> str:
    """Convenience wrapper for translate."""

    return translate(key, **kwargs)

